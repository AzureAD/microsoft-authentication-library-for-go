trigger: 
 - main

pool:
   vmImage: 'ubuntu-latest'

steps: 
- task: GoTool@0
  inputs:
    version: '1.22.3'
    
- task: Go@0
  inputs:
    command: 'get'
    arguments: '-d -v -t -d ./...'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "Install dependencies"
  
- task: Go@0
  inputs:
    command: 'build'
    arguments: './apps/...'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "Build"

# Begin Azure Key Vault integration
- task: AzureKeyVault@2
  displayName: 'Connect to Key Vault'
  inputs:
    azureSubscription: 'AuthSdkResourceManager'
    KeyVaultName: 'msidlabs'
    SecretsFilter: 'LabVaultAccessCert'

- powershell: |
   $pfxPath = '$(Build.SourcesDirectory)' + "/TestCert.pfx"
   $kvSecretBytes = [System.Convert]::FromBase64String('$(LabVaultAccessCert)')
   [System.IO.File]::WriteAllBytes($pfxPath, $kvSecretBytes)

   # Load the certificate directly from the file
   $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($pfxPath, $null)

   # Export the certificate and private key to PEM format
   $pemCertPath = '$(Build.SourcesDirectory)' + "/TestCert.pem"
   $pemKeyPath = '$(Build.SourcesDirectory)' + "/TestCert.key"
   $certExported = [System.Security.Cryptography.X509Certificates.X509ContentType]::Cert
   $keyExported = [System.Security.Cryptography.X509Certificates.X509ContentType]::Pkcs12
   [System.IO.File]::WriteAllText($pemCertPath, [System.Convert]::ToBase64String($cert.Export($certExported)))
   [System.IO.File]::WriteAllText($pemKeyPath, [System.Convert]::ToBase64String($cert.Export($keyExported)))

  displayName: 'Convert and Install Certificate for Linux'
  
- task: Go@0
  inputs:       
    command: 'test'
    arguments: '-race -short ./apps/cache/... ./apps/confidential/... ./apps/public/... ./apps/internal/...'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "Run Unit Tests"

- task: Go@0
  inputs:       
    command: 'test'
    arguments: '-race ./apps/tests/integration/...'
    workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "Run Integration Tests"
  

